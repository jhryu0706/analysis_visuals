<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relationship Graph</title>

  <!-- Cytoscape -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { display: grid; grid-template-columns: 300px 1fr; height: 100vh; }
    #sidebar { border-right: 1px solid #ddd; padding: 14px; overflow: auto; }
    #cy { width: 100%; height: 100vh; }

    .legend { display: grid; gap: 8px; margin-top: 12px; }
    .legend button {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; border: 1px solid #ddd;
      background: #fff; border-radius: 10px;
      cursor: pointer;
    }
    .legend button.active {
      outline: 3px solid #000;
      outline-offset: 2px;
    }
    .swatch {
      width: 14px; height: 14px;
      border-radius: 50%;
    }
    .muted { opacity: 0.12; }

    .pill {
      display:inline-block;
      padding:2px 8px;
      font-size:12px;
      border:1px solid #ddd;
      border-radius:999px;
      color:#444;
    }
    .hint { font-size: 12px; color: #666; line-height: 1.4; }
    button.secondary {
      padding:10px;
      border:1px solid #ddd;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      margin-top:8px;
    }
  </style>
</head>

<body>
<div id="wrap">
  <aside id="sidebar">
    <h2 style="margin:0;">Graph</h2>
    <span id="counts" class="pill">…</span>

    <p class="hint" style="margin-top:8px;">
      Top 5 values per category.<br>
      Click a legend item to highlight nodes of that type.
    </p>

    <button id="resetBtn" class="secondary">Reset</button>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0;" />

    <h3 style="margin:0 0 6px 0; font-size:14px;">Legend</h3>
    <div class="legend" id="legend"></div>

    <p id="status" class="hint" style="margin-top:10px;"></p>
  </aside>

  <main>
    <div id="cy"></div>
  </main>
</div>

<script>
  // ========= CONFIG =========
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQITmhFpwJgwfuSQFnAzUANUOB65EHTXydhXAc62IM5H-NUGhcmo-5vI9Md6-HFf2gzIYXurbqPw0tJ/pub?output=csv";

  const COLUMNS = [
    "sender_name",
    "sender_agent",
    "sender_operator",
    "payee_name",
    "payee_agent",
    "payee_operator"
  ];

  const AMOUNT_COLUMN = "amount";
  const TOP_N = 5;

  const TYPE_COLORS = {
    sender_name: "#1f77b4",
    sender_agent: "#ff7f0e",
    sender_operator: "#2ca02c",
    payee_name: "#d62728",
    payee_agent: "#9467bd",
    payee_operator: "#8c564b"
  };

  let cy = null;
  let activeType = null;

  // ========= HELPERS =========
  const normalize = v => {
    if (v == null) return "";
    const s = String(v).trim();
    if (!s || ["nan","null","undefined"].includes(s.toLowerCase())) return "";
    return s;
  };

  const toNumber = v => {
    const n = Number(normalize(v).replace(/,/g,""));
    return Number.isFinite(n) ? n : 0;
  };

  function initLegend() {
    const el = document.getElementById("legend");
    el.innerHTML = "";

    for (const type of COLUMNS) {
      const btn = document.createElement("button");
      btn.dataset.type = type;

      const sw = document.createElement("span");
      sw.className = "swatch";
      sw.style.background = TYPE_COLORS[type];

      const label = document.createElement("span");
      label.textContent = type;

      btn.append(sw, label);
      btn.onclick = () => toggleType(type);
      el.appendChild(btn);
    }
  }

  function toggleType(type) {
    activeType = activeType === type ? null : type;

    document.querySelectorAll(".legend button").forEach(b => {
      b.classList.toggle("active", b.dataset.type === activeType);
    });

    if (!cy) return;

    if (!activeType) {
      cy.elements().removeClass("muted");
      return;
    }

    cy.nodes().forEach(n => {
      n.toggleClass("muted", n.data("type") !== activeType);
    });

    cy.edges().forEach(e => {
      const s = e.source().data("type");
      const t = e.target().data("type");
      e.toggleClass("muted", s !== activeType && t !== activeType);
    });
  }

  async function loadCSV() {
    return new Promise((resolve, reject) => {
      Papa.parse(SHEET_CSV_URL, {
        header: true,
        download: true,
        skipEmptyLines: true,
        complete: res => resolve(res.data || []),
        error: reject
      });
    });
  }

  function buildGraph(rows) {
    const counts = {};
    COLUMNS.forEach(c => counts[c] = new Map());

    rows.forEach(r => {
      COLUMNS.forEach(c => {
        const v = normalize(r[c]);
        if (v) counts[c].set(v, (counts[c].get(v)||0)+1);
      });
    });

    const top = {};
    COLUMNS.forEach(c => {
      top[c] = new Set(
        [...counts[c].entries()]
          .sort((a,b)=>b[1]-a[1])
          .slice(0, TOP_N)
          .map(d=>d[0])
      );
    });

    const nodes = new Map();
    const edges = new Map();

    rows.forEach(r => {
      const amt = toNumber(r[AMOUNT_COLUMN]);
      const present = [];

      COLUMNS.forEach(c => {
        const v = normalize(r[c]);
        if (!v || !top[c].has(v)) return;
        const id = `${c}::${v}`;

        if (!nodes.has(id)) {
          nodes.set(id, {
            data: { id, label: v, type: c, amount: 0 }
          });
        }
        nodes.get(id).data.amount += amt;
        present.push(id);
      });

      for (let i=0;i<present.length;i++) {
        for (let j=i+1;j<present.length;j++) {
          const a = present[i], b = present[j];
          const key = a<b ? `${a}__${b}` : `${b}__${a}`;
          if (!edges.has(key)) {
            edges.set(key, { data: { id:key, source:a, target:b, weight:0, amount:0 } });
          }
          edges.get(key).data.weight++;
          edges.get(key).data.amount += amt;
        }
      }
    });

    return {
      nodes: [...nodes.values()],
      edges: [...edges.values()]
    };
  }

  function render(elements) {
    if (cy) cy.destroy();

    cy = cytoscape({
      container: document.getElementById("cy"),
      elements: [...elements.nodes, ...elements.edges],
      style: [
        {
          selector: "node",
          style: {
            "background-color": e => TYPE_COLORS[e.data("type")],
            "label": "data(label)",
            "font-size": 10,
            "text-outline-width": 2,
            "text-outline-color": "#fff",
            "width": 18,
            "height": 18
          }
        },
        {
          selector: "edge",
          style: {
            "width": e => Math.min(1+e.data("weight"),8),
            "opacity": 0.35,
            "line-color": "#999"
          }
        },
        { selector: ".muted", style: { "opacity": 0.12 } }
      ],
      layout: { name:"cose", animate:true }
    });
  }

  async function main() {
    initLegend();
    document.getElementById("resetBtn").onclick = () => toggleType(null);

    try {
      document.getElementById("status").textContent = "Loading CSV…";
      const rows = await loadCSV();
      const graph = buildGraph(rows);
      document.getElementById("counts").textContent =
        `${graph.nodes.length} nodes • ${graph.edges.length} edges`;
      render(graph);
      document.getElementById("status").textContent =
        `Loaded ${rows.length} rows • showing top ${TOP_N} per category`;
    } catch (e) {
      console.error(e);
      document.getElementById("status").textContent = "Error loading data";
      alert(e.message);
    }
  }

  main();
</script>
</body>
</html>
